#!/usr/bin/env bash
set -e

echo "- create groups if necessary..."

{{.createGroups}}

# echo "group_exists: ${group_exists}"
# echo "      errors: ${errors}"
# echo "-------------------------------"

echo "- creating user..."
existing_user_by_uid=`getent passwd "1000" | cut -f1 -d: || true`
if [ -n "${existing_user_by_uid}" ]; then userdel -r "${existing_user_by_uid}"; fi

existing_user_by_name=`getent passwd "{{.username}}" | cut -f1 -d: || true`
existing_user_uid=`getent passwd "{{.username}}" | cut -f3 -d: || true`
if [ -n "${existing_user_by_name}" ]; then find / -uid ${existing_user_uid} -exec chown -h {{.uid}} {} + || true ; find / -gid ${existing_user_uid} -exec chgrp -h {{.ugid}} {} + || true ; fi
if [ -n "${existing_user_by_name}" ]; then userdel -r "${existing_user_by_name}"; fi

# existing_group_by_gid=`getent group "1000" | cut -f1 -d: || true`
# if [ -z "${existing_group_by_gid}" ]; then groupadd -g "{{.ugid}}" "{{.username}}"; fi

useradd --no-log-init --no-create-home --uid "{{.uid}}" -s "/bin/bash" -c "{{.Name}}" -g "{{.ugid}}" -G "{{.gnames}}" -d "{{.homedir}}" "{{.username}}"

echo "- create homedir: {{.homedir}}"
echo "PS1=\"üê≥ \${PS1}\"" >> "/etc/skel/.bashrc"
echo "PS1=\"üê≥ \${PS1}\"" >> "/root/.bashrc"
mkdir -pv "{{.homedir}}"
mkhomedir_helper {{.username}}
cp -nr /etc/skel/. "{{.homedir}}"
chown {{.uid}}:{{.ugid}} "{{.homedir}}"

echo "- setup matrix command!"
create_bash_script() {
    file=/usr/local/bin/$1
    script=$2
    echo '#!/usr/bin/env bash' > $file
    echo "$script" >> $file
    chmod +x $file
}

create_bash_script matrix \
                   'dogi'

###############################################################
# setup sudo
set +e
distro_ubuntu=$(grep -i ubuntu /etc/os-release)
distro_fedora=$(grep -i fedora /etc/os-release)
distro_debian=$(grep -i debian /etc/os-release)
set -e
distro_unknown=""
sudo_ok=""
if [ -n "${distro_ubuntu}" ] || [ -n "${distro_debian}" ]; then
    if [ -n "${distro_ubuntu}" ]; then
        echo -n "- Ubuntu distro, "
    else
        echo -n "- Debian distro, "
    fi
    echo "running apt update..."
    env DEBIAN_FRONTEND=noninteractive apt-get -qq update > /dev/null
    echo "- installing sudo, tzdata, vim..."
    env DEBIAN_FRONTEND=noninteractive apt-get -qq install sudo tzdata vim > /dev/null
elif [ -n "${distro_fedora}" ]; then
    echo "- Fedora distro, installing sudo, tzdata, vim..."
    dnf install -y sudo tzdata vim > /dev/null
else
    distro_unknown="True"
fi

if [ -n "${distro_unknown}" ]; then
    echo "- UNKNOWN distro."
else
    echo "{{.username}} ALL=NOPASSWD: ALL" >> /etc/sudoers.d/dogi
    sed -i '/secure_path/ s/^/#/' /etc/sudoers
    sudo_ok="True"
fi
###############################################################

echo "- done, happy üê≥!"
echo "- you now are INSIDE the container"

if [ $# -eq 0 ]; then
    if [ -n "${sudo_ok}" ]; then
        echo "- switch to user {{.username}}"
        sudo -EHu {{.username}} bash
    else
        echo "- sudo not setup, will run as root"
        bash
    fi
fi

if [ -n "${sudo_ok}" ]; then
    echo "- run as user: $@"
    sudo -EHu {{.username}} "$@"
else
    echo "- sudo not setup, will run as root"
    $@
fi

# TODO: remove these used in tests
# echo "- run as user: $*"
# echo "- run as user: ${*@Q}"
# echo "- run as user: ${@@Q}"
# sudo -Hu {{.username}} bash -c "$@"
# exec su {{.username}} - '$*'
